#include <pitches.h>

int melody0[] = {
NOTE_E5,
NOTE_B4,
NOTE_C5,
NOTE_D5,
NOTE_C5,
NOTE_B4,
NOTE_A4,
NOTE_A4,
NOTE_C5,
NOTE_E5,
NOTE_D5,
NOTE_C5,
NOTE_B4,
NOTE_C5,
NOTE_D5,
NOTE_E5,
NOTE_C5,
NOTE_A4,
NOTE_A4,
NOTE_D5,
NOTE_F5,
NOTE_A5,
NOTE_G5,
NOTE_F5,
NOTE_E5,
NOTE_C5,
NOTE_E5,
NOTE_D5,
NOTE_C5,
NOTE_B4,
NOTE_B4,
NOTE_C5,
NOTE_D5,
NOTE_E5,
NOTE_C5,
NOTE_A4,
NOTE_A4,
NOTE_E5,
NOTE_B4,
NOTE_C5,
NOTE_D5,
NOTE_C5,
NOTE_B4,
NOTE_A4,
NOTE_A4,
NOTE_C5,
NOTE_E5,
NOTE_D5,
NOTE_C5,
NOTE_B4,
NOTE_C5,
NOTE_D5,
NOTE_E5,
NOTE_C5,
NOTE_A4,
NOTE_A4,
NOTE_D5,
NOTE_F5,
NOTE_A5,
NOTE_G5,
NOTE_F5,
NOTE_E5,
NOTE_C5,
NOTE_E5,
NOTE_D5,
NOTE_C5,
NOTE_B4,
NOTE_B4,
NOTE_C5,
NOTE_D5,
NOTE_E5,
NOTE_C5,
NOTE_A4,
NOTE_A4,
NOTE_E3,
NOTE_C3,
NOTE_D3,
NOTE_B2,
NOTE_C3,
NOTE_A2,
NOTE_GS2,
NOTE_E3,
NOTE_C3,
NOTE_D3,
NOTE_B2,
NOTE_C3,
NOTE_E3,
NOTE_A3,
NOTE_GS3,
};

int start_time0[] = {
0.0,
400000.0,
600000.0,
800000.0,
1200000.0,
1400000.0,
1600000.0,
2000000.0,
2200000.0,
2400000.0,
2800000.0,
3000000.0,
3200000.0,
3800000.0,
4000000.0,
4400000.0,
4800000.0,
5200000.0,
5600000.0,
6600000.0,
7000000.0,
7200000.0,
7600000.0,
7800000.0,
8000000.0,
8600000.0,
8800000.0,
9200000.0,
9400000.0,
9600000.0,
10000000.0,
10200000.0,
10400000.0,
10800000.0,
11200000.0,
11600000.0,
12000000.0,
12800000.0,
13200000.0,
13400000.0,
13600000.0,
14000000.0,
14200000.0,
14400000.0,
14800000.0,
15000000.0,
15200000.0,
15600000.0,
15800000.0,
16000000.0,
16600000.0,
16800000.0,
17200000.0,
17600000.0,
18000000.0,
18400000.0,
19400000.0,
19800000.0,
20000000.0,
20400000.0,
20600000.0,
20800000.0,
21400000.0,
21600000.0,
22000000.0,
22200000.0,
22400000.0,
22800000.0,
23000000.0,
23200000.0,
23600000.0,
24000000.0,
24400000.0,
24800000.0,
25600000.0,
26400000.0,
27200000.0,
28000000.0,
28800000.0,
29600000.0,
30400000.0,
32000000.0,
32800000.0,
33600000.0,
34400000.0,
35200000.0,
35600000.0,
36000000.0,
36800000.0,
};

int duration0[] = {
333333.333333,
195833.333333,
195833.333333,
333333.333333,
195833.333333,
195833.333333,
333333.333333,
195833.333333,
195833.333333,
333333.333333,
195833.333333,
195833.333333,
533333.333333,
195833.333333,
333333.333333,
333333.333333,
333333.333333,
333333.333333,
333333.333333,
333333.333333,
195833.333333,
333333.333333,
195833.333333,
195833.333333,
533333.333333,
195833.333333,
333333.333333,
195833.333333,
195833.333333,
333333.333333,
195833.333333,
195833.333333,
333333.333333,
333333.333333,
333333.333333,
333333.333333,
333333.333333,
333333.333333,
195833.333333,
195833.333333,
333333.333333,
195833.333333,
195833.333333,
333333.333333,
195833.333333,
195833.333333,
333333.333333,
195833.333333,
195833.333333,
533333.333333,
195833.333333,
333333.333333,
333333.333333,
333333.333333,
333333.333333,
333333.333333,
333333.333333,
195833.333333,
333333.333333,
195833.333333,
195833.333333,
533333.333333,
195833.333333,
333333.333333,
195833.333333,
195833.333333,
333333.333333,
195833.333333,
195833.333333,
333333.333333,
333333.333333,
333333.333333,
333333.333333,
333333.333333,
800000.0,
800000.0,
800000.0,
800000.0,
800000.0,
800000.0,
1500000.0,
800000.0,
800000.0,
800000.0,
700000.0,
333333.333333,
333333.333333,
700000.0,
700000.0,
};

int melody1[] = {
NOTE_E2,
NOTE_E3,
NOTE_E2,
NOTE_E3,
NOTE_E2,
NOTE_E3,
NOTE_E2,
NOTE_E3,
NOTE_A2,
NOTE_A3,
NOTE_A2,
NOTE_A3,
NOTE_A2,
NOTE_A3,
NOTE_A2,
NOTE_A3,
NOTE_GS2,
NOTE_GS3,
NOTE_GS2,
NOTE_GS3,
NOTE_E2,
NOTE_E3,
NOTE_E2,
NOTE_E3,
NOTE_A2,
NOTE_A3,
NOTE_A2,
NOTE_A3,
NOTE_A2,
NOTE_A3,
NOTE_B2,
NOTE_C3,
NOTE_D3,
NOTE_D2,
NOTE_D2,
NOTE_D2,
NOTE_A2,
NOTE_F2,
NOTE_C2,
NOTE_C3,
NOTE_C3,
NOTE_C2,
NOTE_G2,
NOTE_G2,
NOTE_B2,
NOTE_B3,
NOTE_B3,
NOTE_E3,
NOTE_GS3,
NOTE_A2,
NOTE_E3,
NOTE_A2,
NOTE_E3,
NOTE_A2,
NOTE_E2,
NOTE_E3,
NOTE_E2,
NOTE_E3,
NOTE_E2,
NOTE_E3,
NOTE_E2,
NOTE_E3,
NOTE_A2,
NOTE_A3,
NOTE_A2,
NOTE_A3,
NOTE_A2,
NOTE_A3,
NOTE_A2,
NOTE_A3,
NOTE_GS2,
NOTE_GS3,
NOTE_GS2,
NOTE_GS3,
NOTE_E2,
NOTE_E3,
NOTE_E2,
NOTE_E3,
NOTE_A2,
NOTE_A3,
NOTE_A2,
NOTE_A3,
NOTE_A2,
NOTE_A3,
NOTE_B2,
NOTE_C3,
NOTE_D3,
NOTE_D2,
NOTE_D2,
NOTE_D2,
NOTE_A2,
NOTE_F2,
NOTE_C2,
NOTE_C3,
NOTE_C3,
NOTE_C2,
NOTE_G2,
NOTE_G2,
NOTE_B2,
NOTE_B3,
NOTE_B3,
NOTE_E3,
NOTE_GS3,
NOTE_A2,
NOTE_E3,
NOTE_A2,
NOTE_E3,
NOTE_A2,
NOTE_A3,
NOTE_E4,
NOTE_A3,
NOTE_E4,
NOTE_A3,
NOTE_E4,
NOTE_A3,
NOTE_E4,
NOTE_GS3,
NOTE_E4,
NOTE_GS3,
NOTE_E4,
NOTE_GS3,
NOTE_E4,
NOTE_GS3,
NOTE_E4,
NOTE_A3,
NOTE_E4,
NOTE_A3,
NOTE_E4,
NOTE_A3,
NOTE_E4,
NOTE_A3,
NOTE_E4,
NOTE_GS3,
NOTE_E4,
NOTE_GS3,
NOTE_E4,
NOTE_A3,
NOTE_E4,
NOTE_A3,
NOTE_E4,
NOTE_A3,
NOTE_E4,
NOTE_A3,
NOTE_E4,
NOTE_GS3,
NOTE_E4,
NOTE_GS3,
NOTE_E4,
NOTE_GS3,
NOTE_E4,
NOTE_GS3,
NOTE_E4,
NOTE_A3,
NOTE_E4,
NOTE_A3,
NOTE_E4,
NOTE_A3,
NOTE_E4,
NOTE_A3,
NOTE_E4,
NOTE_GS3,
NOTE_E4,
NOTE_GS3,
NOTE_E4,
};

int start_time1[] = {
0.0,
200000.0,
400000.0,
600000.0,
800000.0,
1000000.0,
1200000.0,
1400000.0,
1600000.0,
1800000.0,
2000000.0,
2200000.0,
2400000.0,
2600000.0,
2800000.0,
3000000.0,
3200000.0,
3400000.0,
3600000.0,
3800000.0,
4000000.0,
4200000.0,
4400000.0,
4600000.0,
4800000.0,
5000000.0,
5200000.0,
5400000.0,
5600000.0,
5800000.0,
6000000.0,
6200000.0,
6400000.0,
6600000.0,
7000000.0,
7400000.0,
7600000.0,
7800000.0,
8000000.0,
8200000.0,
8600000.0,
8800000.0,
9000000.0,
9200000.0,
9600000.0,
9800000.0,
10200000.0,
10600000.0,
11000000.0,
11200000.0,
11400000.0,
11600000.0,
11800000.0,
12000000.0,
12800000.0,
13000000.0,
13200000.0,
13400000.0,
13600000.0,
13800000.0,
14000000.0,
14200000.0,
14400000.0,
14600000.0,
14800000.0,
15000000.0,
15200000.0,
15400000.0,
15600000.0,
15800000.0,
16000000.0,
16200000.0,
16400000.0,
16600000.0,
16800000.0,
17000000.0,
17200000.0,
17400000.0,
17600000.0,
17800000.0,
18000000.0,
18200000.0,
18400000.0,
18600000.0,
18800000.0,
19000000.0,
19200000.0,
19400000.0,
19800000.0,
20200000.0,
20400000.0,
20600000.0,
20800000.0,
21000000.0,
21400000.0,
21600000.0,
21800000.0,
22000000.0,
22400000.0,
22600000.0,
23000000.0,
23400000.0,
23800000.0,
24000000.0,
24200000.0,
24400000.0,
24600000.0,
24800000.0,
25600000.0,
25800000.0,
26000000.0,
26200000.0,
26400000.0,
26600000.0,
26800000.0,
27000000.0,
27200000.0,
27400000.0,
27600000.0,
27800000.0,
28000000.0,
28200000.0,
28400000.0,
28600000.0,
28800000.0,
29000000.0,
29200000.0,
29400000.0,
29600000.0,
29800000.0,
30000000.0,
30200000.0,
30400000.0,
30600000.0,
30800000.0,
31000000.0,
32000000.0,
32200000.0,
32400000.0,
32600000.0,
32800000.0,
33000000.0,
33200000.0,
33400000.0,
33600000.0,
33800000.0,
34000000.0,
34200000.0,
34400000.0,
34600000.0,
34800000.0,
35000000.0,
35200000.0,
35400000.0,
35600000.0,
35800000.0,
36000000.0,
36200000.0,
36400000.0,
36600000.0,
36800000.0,
37000000.0,
37200000.0,
37400000.0,
};

int duration1[] = {
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
333333.333333,
333333.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
333333.333333,
195833.333333,
195833.333333,
195833.333333,
333333.333333,
195833.333333,
333333.333333,
333333.333333,
333333.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
333333.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
333333.333333,
333333.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
333333.333333,
195833.333333,
195833.333333,
195833.333333,
333333.333333,
195833.333333,
333333.333333,
333333.333333,
333333.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
333333.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
};

int melody2[] = {
NOTE_B4,
NOTE_GS4,
NOTE_A4,
NOTE_B4,
NOTE_E5,
NOTE_D5,
NOTE_A4,
NOTE_GS4,
NOTE_E4,
NOTE_A4,
NOTE_C5,
NOTE_B4,
NOTE_A4,
NOTE_GS4,
NOTE_GS4,
NOTE_E4,
NOTE_GS4,
NOTE_A4,
NOTE_B4,
NOTE_C5,
NOTE_A4,
NOTE_E4,
NOTE_E4,
NOTE_D3,
NOTE_F4,
NOTE_A4,
NOTE_C5,
NOTE_C5,
NOTE_C5,
NOTE_B4,
NOTE_A4,
NOTE_G4,
NOTE_E4,
NOTE_G4,
NOTE_A4,
NOTE_G4,
NOTE_F4,
NOTE_E4,
NOTE_GS4,
NOTE_E4,
NOTE_GS4,
NOTE_A4,
NOTE_B4,
NOTE_GS4,
NOTE_C5,
NOTE_GS4,
NOTE_A4,
NOTE_C5,
NOTE_A4,
NOTE_E4,
NOTE_E4,
NOTE_B4,
NOTE_GS4,
NOTE_A4,
NOTE_B4,
NOTE_E5,
NOTE_D5,
NOTE_A4,
NOTE_GS4,
NOTE_E4,
NOTE_A4,
NOTE_C5,
NOTE_B4,
NOTE_A4,
NOTE_GS4,
NOTE_GS4,
NOTE_E4,
NOTE_GS4,
NOTE_A4,
NOTE_B4,
NOTE_C5,
NOTE_A4,
NOTE_E4,
NOTE_E4,
NOTE_D3,
NOTE_F4,
NOTE_A4,
NOTE_C5,
NOTE_C5,
NOTE_C5,
NOTE_B4,
NOTE_A4,
NOTE_G4,
NOTE_E4,
NOTE_G4,
NOTE_A4,
NOTE_G4,
NOTE_F4,
NOTE_E4,
NOTE_GS4,
NOTE_E4,
NOTE_GS4,
NOTE_A4,
NOTE_B4,
NOTE_GS4,
NOTE_C5,
NOTE_GS4,
NOTE_A4,
NOTE_C5,
NOTE_A4,
NOTE_E4,
NOTE_E4,
NOTE_C3,
NOTE_A2,
NOTE_B2,
NOTE_GS2,
NOTE_A2,
NOTE_E2,
NOTE_B2,
NOTE_C3,
NOTE_A2,
NOTE_B2,
NOTE_GS2,
NOTE_A2,
NOTE_C3,
NOTE_E3,
NOTE_D3,
};

int start_time2[] = {
0.0,
400000.0,
600000.0,
800000.0,
1000000.0,
1100000.0,
1200000.0,
1400000.0,
1600000.0,
2200000.0,
2400000.0,
2800000.0,
3000000.0,
3200000.0,
3300000.0,
3400000.0,
3600000.0,
3800000.0,
4000000.0,
4400000.0,
4800000.0,
5200000.0,
5600000.0,
6400000.0,
6600000.0,
7000000.0,
7200000.0,
7400000.0,
7500000.0,
7600000.0,
7800000.0,
8000000.0,
8600000.0,
8800000.0,
9000000.0,
9100000.0,
9200000.0,
9400000.0,
9600000.0,
9800000.0,
10000000.0,
10200000.0,
10400000.0,
10600000.0,
10800000.0,
11000000.0,
11200000.0,
11300000.0,
11400000.0,
11600000.0,
12000000.0,
12800000.0,
13200000.0,
13400000.0,
13600000.0,
13800000.0,
13900000.0,
14000000.0,
14200000.0,
14400000.0,
15000000.0,
15200000.0,
15600000.0,
15800000.0,
16000000.0,
16100000.0,
16200000.0,
16400000.0,
16600000.0,
16800000.0,
17200000.0,
17600000.0,
18000000.0,
18400000.0,
19200000.0,
19400000.0,
19800000.0,
20000000.0,
20200000.0,
20300000.0,
20400000.0,
20600000.0,
20800000.0,
21400000.0,
21600000.0,
21800000.0,
21900000.0,
22000000.0,
22200000.0,
22400000.0,
22600000.0,
22800000.0,
23000000.0,
23200000.0,
23400000.0,
23600000.0,
23800000.0,
24000000.0,
24100000.0,
24200000.0,
24400000.0,
24800000.0,
25600000.0,
26400000.0,
27200000.0,
28000000.0,
28800000.0,
29600000.0,
31200000.0,
32000000.0,
32800000.0,
33600000.0,
34400000.0,
35200000.0,
35600000.0,
36000000.0,
36800000.0,
};

int duration2[] = {
333333.333333,
195833.333333,
195833.333333,
195833.333333,
95833.3333333,
95833.3333333,
195833.333333,
195833.333333,
333333.333333,
195833.333333,
333333.333333,
195833.333333,
195833.333333,
95833.3333333,
95833.3333333,
195833.333333,
195833.333333,
195833.333333,
333333.333333,
333333.333333,
333333.333333,
333333.333333,
333333.333333,
195833.333333,
333333.333333,
195833.333333,
195833.333333,
95833.3333333,
95833.3333333,
195833.333333,
195833.333333,
533333.333333,
195833.333333,
195833.333333,
95833.3333333,
95833.3333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
95833.3333333,
95833.3333333,
195833.333333,
333333.333333,
333333.333333,
333333.333333,
195833.333333,
195833.333333,
195833.333333,
95833.3333333,
95833.3333333,
195833.333333,
195833.333333,
333333.333333,
195833.333333,
333333.333333,
195833.333333,
195833.333333,
95833.3333333,
95833.3333333,
195833.333333,
195833.333333,
195833.333333,
333333.333333,
333333.333333,
333333.333333,
333333.333333,
333333.333333,
195833.333333,
333333.333333,
195833.333333,
195833.333333,
95833.3333333,
95833.3333333,
195833.333333,
195833.333333,
533333.333333,
195833.333333,
195833.333333,
95833.3333333,
95833.3333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
195833.333333,
95833.3333333,
95833.3333333,
195833.333333,
333333.333333,
333333.333333,
800000.0,
800000.0,
800000.0,
800000.0,
800000.0,
1600000.0,
333333.333333,
800000.0,
800000.0,
800000.0,
700000.0,
333333.333333,
333333.333333,
700000.0,
700000.0,
};



int main_cycle_usec = 10;
int master_time = 0;

int notepin0 = 3;
int notepin2 = 5;
int notepin1 = 25;

int elapsed0 = 0;
int elapsed1 = 0;
int elapsed2 = 0;

int state0 = 0;
int state1 = 0;
int state2 = 0;

void setup() {
  Serial.begin(9600);
  pinMode(13, OUTPUT);
  pinMode(notepin0, OUTPUT);
  pinMode(notepin1, OUTPUT);
  pinMode(notepin2, OUTPUT);

  digitalWrite(13, HIGH);
  delay(500);
  digitalWrite(13, LOW);
  delay(500);
  digitalWrite(13, HIGH);
  delay(500);
  digitalWrite(13, LOW);
  delay(500);
//  tone(3, 40);
//  tone(9, 440);
  
}

float current_time;

int size0 = sizeof(melody0)/sizeof(melody0[0]);
int size1 = sizeof(melody1)/sizeof(melody1[0]);
int size2 = sizeof(melody2)/sizeof(melody2[0]);


void loop() {
  Serial.println(size0);
  Serial.println(size1);
  Serial.println(size2);
  
  int usec2 = 0;//(1000000/freq2)/2;

  int end0 = 0;
  int end1 = 0;
  int end2 = 0;

  int i = -1;
  int j = -1;
  int k = -1;
    
  int note0_active = 0;
  float note0_start = 0;
  float note0_end = micros();
  float wait_time0 = 0;
  
  int note1_active = 0;
  float note1_start = 0;
  float note1_end = micros();
  float wait_time1 = 0;
  
  int note2_active = 0;
  float note2_start = 0;
  float note2_end = micros();
  float wait_time2 = 0;

  float start_time = micros();

  while(1){

    current_time = micros();


    // ### VOICE 0 ### //
        
    if (!note0_active){
      // Check if voice is already done, do nothing if True
      if (end0){
        i;
      }
      // Check if note needs to start
      else if ((current_time - note0_end) >= wait_time0){
        i++;
//        Serial.print("I: ");
//        Serial.println(i);
        note0_active = 1;
        analogWriteFrequency(notepin0, melody0[i]);
        analogWrite(notepin0, 128);
        note0_start = micros();
      }
    }
    else{
      // Check if note needs to end      
      if ((current_time - note0_start) >= duration0[i]){
        note0_active = 0;
        analogWrite(notepin0, 0);

        // Check if already at song end
        if (i+1 == size0){
//          Serial.println("END0");
          end0 = 1;
        }
        else{
          note0_end = micros();
          wait_time0 = start_time0[i+1] - (start_time0[i] + duration0[i]); // consider hardcoding this to reduce cycle time
        }
      }  
    }



    // ### VOICE 1 ### //
    
    if (!note1_active){
      // Check if voice is already done, do nothing if True
      if (end1){
        j;
      }
      // Check if note needs to start
      else if ((current_time - note1_end) >= wait_time1){
        j++;
//        Serial.print("J: ");
//        Serial.println(j);
        note1_active = 1;
        analogWriteFrequency(notepin1, melody1[j]);
        analogWrite(notepin1, 128);
        note1_start = micros();
      }
    }
    else{
      // Check if note needs to end      
      if ((current_time - note1_start) >= duration1[j]){
        note1_active = 0;
        analogWrite(notepin1, 0);

        // Check if already at song end
        if (j+1 == size1){
//          Serial.println("END1");
          end1 = 1;
        }
        else{
          note1_end = micros();
          wait_time1 = start_time1[j+1] - (start_time1[j] + duration1[j]); // consider hardcoding this to reduce cycle time
        }
      }
    }


    // ### VOICE 2 ### //

    if (!note2_active){
      // Check if voice is already done, do nothing if True
      if (end2){
        k;
      }
      // Check if note needs to start
      else if ((current_time - note2_end) >= wait_time2){
        k++;
//        Serial.print("k: ");
//        Serial.println(k);
        note2_active = 1;
        analogWriteFrequency(notepin2, melody2[k]);
        analogWrite(notepin2, 128);
        note2_start = micros();
      }
    }
    else{
      // Check if note needs to end      
      if ((current_time - note2_start) >= duration2[k]){
        note2_active = 0;
        analogWrite(notepin2, 0);

        // Check if already at song end
        if (k+1 == size2){
//          Serial.println("END2");
          end2 = 1;
        }
        else{
          note2_end = micros();
          wait_time2 = start_time2[k+1] - (start_time2[k] + duration2[k]); // consider hardcoding this to reduce cycle time
        }
      }
    }
//
//    if (!note2_active){
//      // Check if voice is already done, do nothing if True
//      if (end2){
//        k;
//      }
//      // Check if note needs to start
//      else if ((current_time - note2_end) >= wait_time2){
//        k++;
////        Serial.print("K: ");
////        Serial.println(k);
//        note2_active = 1;
//        digitalWrite(notepin2, HIGH);
//        elapsed2 = 0;
//        note2_start = micros();
//        usec2 = (1000000/melody2[k])/2;
//      }
//    }
//    else{
//      // Check if note needs to end      
//      if ((current_time - note2_start) >= duration2[k]){
//        note2_active = 0;
//        digitalWrite(notepin2, LOW);
//
//        // Check if already at song end
//        if (k+1 == size2){
////          Serial.println("END2");
//          end2 = 1;
//        }
//        else{
//          note2_end = micros();
//          wait_time2 = start_time2[k+1] - (start_time2[k] + duration2[k]); // consider hardcoding this to reduce cycle time
//        }
//      }

//      // If didn't end, check proper note state and set if needed
//      if (elapsed2 > usec2){
//        state2 = !state2;
//        digitalWrite(notepin2, state2);
//        elapsed2 = 0;
//      }      
//    }

    // If all voices are finished, break out of while loop and play song again
    if (end0 & end1 & end2){
      break;
    }

//    elapsed2 += main_cycle_usec;
    delayMicroseconds(main_cycle_usec);
  }

  digitalWrite(13, HIGH);
  delay(500);
  digitalWrite(13, LOW);
  delay(500);
  digitalWrite(13, HIGH);
  delay(500);
  digitalWrite(13, LOW);
  delay(500);
}
